<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberIQ Demo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 40px 20px; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .logo { font-size: 42px; font-weight: 700; margin-bottom: 10px; }
        .tagline { font-size: 18px; opacity: 0.95; }
        .stats-container { display: flex; gap: 20px; margin-bottom: 40px; flex-wrap: wrap; justify-content: center; }
        .stat-badge { background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); padding: 12px 24px; border-radius: 25px; color: white; font-weight: 600; font-size: 14px; border: 1px solid rgba(255, 255, 255, 0.3); }
        .main-card { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); padding: 60px 50px; max-width: 750px; width: 100%; margin: 0 auto 30px; text-align: center; }
        .welcome-title { font-size: 36px; font-weight: 700; color: #2d3748; margin-bottom: 20px; }
        .welcome-description { font-size: 16px; color: #718096; margin-bottom: 40px; line-height: 1.6; }
        .try-label { font-size: 14px; color: #a0aec0; font-weight: 600; margin-bottom: 15px; }
        .suggestions { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin-bottom: 80px; }
        .suggestion-btn { background: #f7fafc; border: 1px solid #e2e8f0; padding: 8px 16px; border-radius: 18px; color: #4a5568; font-size: 13px; cursor: pointer; transition: all 0.2s; font-weight: 500; }
        .suggestion-btn:hover { background: #edf2f7; transform: translateY(-2px); }
        .input-container { display: flex; gap: 12px; align-items: center; }
        .query-input { flex: 1; padding: 16px 20px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 15px; outline: none; }
        .query-input:focus { border-color: #667eea; }
        .send-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 16px 32px; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; }
        .send-btn:hover { transform: translateY(-2px); }
        .send-btn:disabled { background: #cbd5e0; cursor: not-allowed; }
        .loading { display: none; text-align: center; margin-top: 40px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { color: white; font-size: 16px; }
        .results-container { display: none; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); padding: 40px; max-width: 1000px; width: 100%; margin: 0 auto; }
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px; }
        .results-title { font-size: 24px; font-weight: 700; color: #2d3748; }
        .header-actions { display: flex; gap: 10px; }
        .performance-badge { background: #48bb78; color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; }
        .generate-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; }
        .generate-btn:hover { transform: translateY(-2px); }
        .generate-btn:disabled { background: #cbd5e0; cursor: not-allowed; }
        .results-content { color: #4a5568; line-height: 1.8; font-size: 15px; }
        .results-content table { margin-bottom: 20px !important; }
        .results-content p { margin: 10px 0; }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">üõ°Ô∏è CyberIQ Demo</div>
        <div class="tagline">AI-Powered Threat Intelligence Platform</div>
    </div>
    
    <div class="stats-container">
        <div class="stat-badge">691 MITRE Techniques</div>
        <div class="stat-badge">1,499 CISA KEVs</div>
        <div class="stat-badge">2,190 Total Items</div>
    </div>
    
    <div class="main-card" id="main-card">
        <h1 class="welcome-title">Welcome to CyberIQ</h1>
        <p class="welcome-description">Ask me anything about threat intelligence, vulnerabilities, or attack techniques.</p>
        <div class="try-label">Try these:</div>
        <div class="suggestions">
            <button class="suggestion-btn" onclick="fillQuery('Top 5 KEVs by CVSS')">Top 5 KEVs by CVSS</button>
            <button class="suggestion-btn" onclick="fillQuery('Ransomware KEVs')">Ransomware KEVs</button>
            <button class="suggestion-btn" onclick="fillQuery('Microsoft vulnerabilities')">Microsoft KEVs</button>
        </div>
        <div class="input-container">
            <input type="text" class="query-input" id="query-input" placeholder="Ask about threats..." onkeypress="if(event.key==='Enter')search()">
            <button class="send-btn" id="send-btn" onclick="search()">Send</button>
        </div>
    </div>
    
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p class="loading-text">Analyzing...</p>
    </div>
    
    <div class="results-container" id="results-container">
        <div class="results-header">
            <h2 class="results-title">Analysis Results</h2>
            <div class="header-actions">
                <div class="performance-badge" id="performance-badge"></div>
                <button class="generate-btn" id="generate-btn" onclick="openQueryTab()">üîç Generate SIEM Queries</button>
            </div>
        </div>
        <div class="results-content" id="results-content"></div>
    </div>
    
    <script>
    let lastQuery = '';
    
    function fillQuery(text) {
        document.getElementById('query-input').value = text;
    }
    
    async function search() {
        const query = document.getElementById('query-input').value.trim();
        if (!query) { alert('Please enter a query'); return; }
        
        lastQuery = query;
        document.getElementById('main-card').style.display = 'none';
        document.getElementById('loading').style.display = 'block';
        document.getElementById('results-container').style.display = 'none';
        document.getElementById('send-btn').disabled = true;
        
        const startTime = Date.now();
        
        try {
            const response = await fetch('/api/query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query, vendor: '', date_filter: '' })
            });
            
            if (!response.ok) throw new Error('Query failed');
            
            const data = await response.json();
            const duration = ((Date.now() - startTime) / 1000).toFixed(1);
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results-container').style.display = 'block';
            document.getElementById('send-btn').disabled = false;
            document.getElementById('performance-badge').textContent = '‚ö° ' + duration + 's';
            
            let html = data.response;
            
            // DON'T process HTML responses - they're already formatted!
            if (!html.includes('<table')) {
                // Only convert newlines for plain text
                html = html.replace(/\n/g, '<br>');
            }
            
            document.getElementById('results-content').innerHTML = html;
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('main-card').style.display = 'block';
            document.getElementById('send-btn').disabled = false;
            alert('Error analyzing query');
        }
    }
    
    function openQueryTab() {
        if (!lastQuery) { alert('Please run a query first'); return; }
        
        const tab = window.open('', '_blank');
        const doc = tab.document;
        
        doc.open();
        doc.write('<!DOCTYPE html><html><head><meta charset="UTF-8"><title>SIEM Queries</title>');
        doc.write('<style>');
        doc.write('* { margin: 0; padding: 0; box-sizing: border-box; }');
        doc.write('body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:40px 20px}');
        doc.write('.header{text-align:center;color:white;margin-bottom:40px}');
        doc.write('h1{font-size:36px;font-weight:700;margin-bottom:10px}');
        doc.write('.subtitle{font-size:16px;opacity:0.95;margin-bottom:40px}');
        doc.write('.buttons{display:flex;gap:15px;justify-content:center;margin-bottom:30px;flex-wrap:wrap}');
        doc.write('button{background:rgba(255,255,255,0.95);color:#667eea;border:none;padding:15px 30px;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.2s;box-shadow:0 4px 15px rgba(0,0,0,0.2)}');
        doc.write('button:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.3);background:white}');
        doc.write('button:disabled{background:#cbd5e0;color:#718096;cursor:not-allowed;box-shadow:none}');
        doc.write('.result{background:white;padding:40px;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);max-width:1000px;margin:0 auto;display:none}');
        doc.write('.result.show{display:block}');
        doc.write('.query-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}');
        doc.write('h2{color:#667eea;margin:0;font-size:24px}');
        doc.write('.copy{background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;transition:transform 0.2s}');
        doc.write('.copy:hover{transform:translateY(-2px)}');
        doc.write('.copy.copied{background:#48bb78}');
        doc.write('pre{background:#1e1e1e;color:#d4d4d4;padding:20px;border-radius:8px;overflow-x:auto;font-size:13px;line-height:1.6;white-space:pre-wrap;margin:0}');
        doc.write('.loading{text-align:center;padding:60px;color:white;display:none}');
        doc.write('.loading.show{display:block}');
        doc.write('.spinner{border:4px solid rgba(255,255,255,0.3);border-top:4px solid white;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 20px}');
        doc.write('@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}');
        doc.write('.loading-text{font-size:16px}');
        doc.write('</style></head><body>');
        doc.write('<div class="header">');
        doc.write('<h1>üîç SIEM Detection Queries</h1>');
        doc.write('<p class="subtitle">Select which query type to generate:</p>');
        doc.write('</div>');
        doc.write('<div class="buttons">');
        doc.write('<button onclick="gen(\'kql\')">Azure Sentinel (KQL)</button>');
        doc.write('<button onclick="gen(\'spl\')">Splunk (SPL)</button>');
        doc.write('<button onclick="gen(\'eql\')">Elasticsearch (EQL)</button>');
        doc.write('</div>');
        doc.write('<div class="loading" id="load"><div class="spinner"></div><p class="loading-text">Generating query...</p></div>');
        doc.write('<div class="result" id="res"><div class="query-header"><h2 id="title"></h2><button class="copy" onclick="cp()">üìã Copy</button></div><pre id="code"></pre></div>');
        doc.write('<script>');
        doc.write('let q="";');
        doc.write('let uq=' + JSON.stringify(lastQuery) + ';');
        doc.write('async function gen(t){');
        doc.write('const ts={kql:"Azure Sentinel (KQL)",spl:"Splunk (SPL)",eql:"Elasticsearch (EQL)"};');
        doc.write('document.getElementById("load").classList.add("show");');
        doc.write('document.getElementById("res").classList.remove("show");');
        doc.write('document.querySelectorAll("button").forEach(b=>b.disabled=true);');
        doc.write('try{');
        doc.write('const r=await fetch(opener.location.origin+"/api/generate-single-query",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query_type:t,query:uq})});');
        doc.write('if(!r.ok)throw new Error("Failed");');
        doc.write('const d=await r.json();');
        doc.write('q=d.query;');
        doc.write('document.getElementById("load").classList.remove("show");');
        doc.write('document.getElementById("res").classList.add("show");');
        doc.write('document.getElementById("title").textContent=ts[t];');
        doc.write('document.getElementById("code").textContent=q;');
        doc.write('}catch(e){alert("Error: "+e.message)}finally{document.querySelectorAll("button").forEach(b=>b.disabled=false)}');
        doc.write('}');
        doc.write('function cp(){navigator.clipboard.writeText(q).then(()=>{const b=document.querySelector(".copy");const o=b.textContent;b.textContent="‚úÖ Copied!";b.classList.add("copied");setTimeout(()=>{b.textContent=o;b.classList.remove("copied")},2000)})}');
        doc.write('</' + 'script></body></html>');
        doc.close();
    }
    </script>
</body>
</html>
