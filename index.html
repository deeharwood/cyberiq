<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberIQ Demo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 40px 20px; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .logo { font-size: 42px; font-weight: 700; margin-bottom: 10px; }
        .tagline { font-size: 18px; opacity: 0.95; }
        .stats-container { display: flex; gap: 20px; margin-bottom: 40px; flex-wrap: wrap; justify-content: center; }
        .stat-badge { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); padding: 16px 28px; border-radius: 12px; color: white; font-weight: 400; font-size: 13px; border: none; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); letter-spacing: 0.5px; text-transform: uppercase; opacity: 0.9; text-align: center; }
        .stat-number { font-size: 28px; font-weight: 700; margin-bottom: 4px; color: white; }
        .stat-label { font-size: 11px; font-weight: 400; opacity: 0.85; letter-spacing: 1px; }
        .main-card { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); padding: 60px 50px; max-width: 750px; width: 100%; margin: 0 auto 30px; text-align: center; }
        .welcome-title { font-size: 36px; font-weight: 700; color: #2d3748; margin-bottom: 20px; }
        .welcome-description { font-size: 16px; color: #718096; margin-bottom: 40px; line-height: 1.6; }
        .try-label { font-size: 14px; color: #a0aec0; font-weight: 600; margin-bottom: 15px; }
        .suggestions { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin-bottom: 80px; }
        .suggestion-btn { background: #f7fafc; border: 1px solid #e2e8f0; padding: 8px 16px; border-radius: 18px; color: #4a5568; font-size: 13px; cursor: pointer; transition: all 0.2s; font-weight: 500; }
        .suggestion-btn:hover { background: #edf2f7; transform: translateY(-2px); }
        .input-container { display: flex; gap: 12px; align-items: center; }
        .query-input { flex: 1; padding: 16px 20px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 15px; outline: none; }
        .query-input:focus { border-color: #667eea; }
        .send-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 16px 32px; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; }
        .send-btn:hover { transform: translateY(-2px); }
        .send-btn:disabled { background: #cbd5e0; cursor: not-allowed; }
        .loading { display: none; text-align: center; margin-top: 40px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { color: white; font-size: 16px; }
        .results-container { display: none; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); padding: 40px; max-width: 1000px; width: 100%; margin: 0 auto; }
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px; }
        .results-title { font-size: 24px; font-weight: 700; color: #2d3748; }
        .header-actions { display: flex; gap: 10px; }
        .performance-badge { background: #48bb78; color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; }
        .generate-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; }
        .generate-btn:hover { transform: translateY(-2px); }
        .generate-btn:disabled { background: #cbd5e0; cursor: not-allowed; }
        .results-content { color: #4a5568; line-height: 1.8; font-size: 15px; }
        .results-content table { margin-bottom: 20px !important; }
        .results-content p { margin: 10px 0; }
        
        /* Sidebar Layout */
        .layout-wrapper { display: flex; max-width: 1400px; margin: 0 auto; gap: 20px; align-items: flex-start; padding: 0 20px; }
        .sidebar { width: 220px; position: sticky; top: 20px; }
        .main-content { flex: 1; min-width: 0; }
        
        /* Collapsible Sidebar Sections */
        .sidebar-section { background: white; border-radius: 12px; padding: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 12px; overflow: hidden; }
        .sidebar-header { 
            padding: 14px 16px; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            user-select: none;
            transition: all 0.2s;
        }
        .sidebar-header:hover { background: linear-gradient(135deg, #764ba2, #667eea); }
        .sidebar-header h3 { 
            margin: 0; 
            font-size: 13px; 
            font-weight: 600; 
            text-transform: uppercase; 
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sidebar-arrow { 
            font-size: 12px; 
            transition: transform 0.3s ease;
            opacity: 0.8;
        }
        .sidebar-arrow.open { transform: rotate(180deg); }
        
        .sidebar-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .sidebar-content.open { 
            max-height: 400px; 
            overflow-y: auto;
        }
        .sidebar-list { 
            display: flex; 
            flex-direction: column; 
            gap: 2px; 
            padding: 12px;
        }
        
        /* Vendor & Sector Items */
        .sidebar-item { 
            width: 100%; 
            text-align: left; 
            padding: 8px 10px; 
            background: transparent; /* No background! */
            color: #4a5568; 
            border: none; 
            border-radius: 6px; 
            font-size: 12px; 
            cursor: pointer; 
            transition: all 0.2s; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .sidebar-item:hover { 
            background: rgba(102, 126, 234, 0.1); /* Subtle hover */
            color: #667eea; 
            transform: translateX(3px); 
        }
        .item-name { font-weight: 500; flex: 1; }
        .item-count { font-size: 10px; opacity: 0.6; margin-left: 8px; }
        .item-arrow { font-size: 10px; opacity: 0.4; }
        .item-emoji { font-size: 14px; margin-right: 8px; }
        
        /* Pagination */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 30px 0; }
        .page-btn { padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .page-btn:hover:not(:disabled) { background: #764ba2; transform: translateY(-2px); }
        .page-btn:disabled { background: #cbd5e0; cursor: not-allowed; }
        .page-info { color: #4a5568; font-size: 14px; font-weight: 500; }
        
        /* Hamburger Menu for Mobile */
        .hamburger { display: none; position: fixed; top: 20px; left: 20px; z-index: 1000; background: white; border: none; border-radius: 8px; padding: 10px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .hamburger-icon { width: 24px; height: 20px; position: relative; }
        .hamburger-icon span { display: block; width: 100%; height: 3px; background: #667eea; margin: 4px 0; border-radius: 2px; transition: all 0.3s; }
        
        /* Mobile Styles */
        @media (max-width: 768px) {
            body { padding: 20px 15px; }
            
            /* Header */
            .header { margin-bottom: 20px; }
            .logo { font-size: 28px; }
            .tagline { font-size: 14px; }
            
            /* Stats - 2x2 Grid */
            .stats-container { gap: 12px; margin-bottom: 25px; }
            .stat-badge { flex: 1 1 calc(50% - 12px); min-width: 140px; padding: 12px 16px; }
            .stat-number { font-size: 22px; }
            .stat-label { font-size: 10px; }
            
            /* Layout - Stack Vertically */
            .layout-wrapper { flex-direction: column; padding: 0; }
            
            /* Sidebar - Collapsible Overlay */
            .sidebar { 
                position: fixed; 
                left: -280px; 
                top: 0; 
                width: 280px; 
                height: 100vh; 
                background: white; 
                z-index: 999; 
                transition: left 0.3s ease;
                box-shadow: 2px 0 10px rgba(0,0,0,0.2);
                overflow-y: auto;
                padding: 20px;
            }
            .sidebar.open { left: 0; }
            .hamburger { display: block; }
            
            .vendor-sidebar { border-radius: 8px; margin-bottom: 15px; }
            .vendor-list { max-height: 300px; }
            .sectors-sidebar { border-radius: 8px; }
            .sectors-list { max-height: 300px; }
            
            /* Main Content */
            .main-content { width: 100%; }
            
            /* Main Card */
            .main-card { padding: 30px 25px; border-radius: 16px; }
            .welcome-title { font-size: 26px; }
            .welcome-description { font-size: 14px; margin-bottom: 30px; }
            
            /* Suggestions */
            .suggestions { margin-bottom: 40px; gap: 8px; }
            .suggestion-btn { padding: 8px 14px; font-size: 12px; }
            
            /* Input Container */
            .input-container { flex-direction: column; gap: 10px; }
            .query-input { padding: 14px 16px; font-size: 14px; width: 100%; }
            .send-btn { width: 100%; padding: 14px; }
            
            /* Loading */
            .loading { padding: 30px 20px; }
            .spinner { width: 40px; height: 40px; }
            
            /* Results */
            .results-container { border-radius: 16px; padding: 25px 20px; }
            .results-header { flex-direction: column; gap: 15px; align-items: flex-start; }
            .results-title { font-size: 22px; }
            .header-actions { flex-direction: column; width: 100%; gap: 8px; }
            .generate-btn { width: 100%; font-size: 13px; padding: 12px; }
            .performance-badge { font-size: 12px; padding: 6px 12px; }
            
            /* Tables - Horizontal Scroll */
            .results-content table { 
                display: block; 
                overflow-x: auto; 
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                font-size: 13px;
            }
            .results-content th,
            .results-content td { 
                padding: 10px !important;
                font-size: 12px !important;
            }
            
            /* Pagination */
            .pagination { flex-wrap: wrap; gap: 8px; margin: 20px 0; }
            .page-btn { padding: 8px 14px; font-size: 12px; }
            .page-info { font-size: 12px; width: 100%; text-align: center; }
        }
        
        /* Tablet Styles */
        @media (max-width: 1024px) and (min-width: 769px) {
            .sidebar { width: 200px; }
            .vendor-sidebar, .sectors-sidebar { padding: 14px; }
            .vendor-item, .sector-item { padding: 7px 9px; font-size: 11px; }
            .main-card { padding: 50px 40px; }
            .results-container { padding: 35px 30px; }
        }
        
        /* Overlay for mobile sidebar */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
        }
        .sidebar-overlay.active { display: block; }
    </style>
</head>
<body>
    <!-- Hamburger Menu Button (Mobile Only) -->
    <button class="hamburger" onclick="toggleSidebar()" aria-label="Toggle menu">
        <div class="hamburger-icon">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </button>
    
    <!-- Sidebar Overlay (Mobile Only) -->
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>
    
    <div class="header">
        <div class="logo">üõ°Ô∏è CyberIQ Demo</div>
        <div class="tagline">AI-Powered Threat Intelligence Platform</div>
    </div>
    
    <div class="stats-container">
        <div class="stat-badge">
            <div class="stat-number" id="stat-zdi">Loading...</div>
            <div class="stat-label">ZDI Advisories</div>
        </div>
        <div class="stat-badge">
            <div class="stat-number" id="stat-nvd">Loading...</div>
            <div class="stat-label">Recent NVD CVEs</div>
        </div>
        <div class="stat-badge">
            <div class="stat-number" id="stat-kevs">1,499</div>
            <div class="stat-label">CISA KEVs</div>
        </div>
        <div class="stat-badge">
            <div class="stat-number" id="stat-total">Loading...</div>
            <div class="stat-label">Total Items</div>
        </div>
    </div>
    
    <!-- Layout Wrapper with Sidebar -->
    <div class="layout-wrapper">
        <!-- Left Sidebar with Collapsible Vendors & Sectors -->
        <aside class="sidebar">
            <!-- Vendors Section -->
            <div class="sidebar-section">
                <div class="sidebar-header" onclick="toggleSection('vendors')">
                    <h3><span>üè¢</span> Vendors</h3>
                    <span class="sidebar-arrow" id="vendors-arrow">‚ñº</span>
                </div>
                <div class="sidebar-content open" id="vendors-content">
                    <div id="vendor-list" class="sidebar-list">
                        <div style="color: #718096; font-size: 12px; padding: 8px;">Loading...</div>
                    </div>
                </div>
            </div>
            
            <!-- Sectors Section -->
            <div class="sidebar-section">
                <div class="sidebar-header" onclick="toggleSection('sectors')">
                    <h3><span>üè≠</span> Sectors</h3>
                    <span class="sidebar-arrow" id="sectors-arrow">‚ñº</span>
                </div>
                <div class="sidebar-content" id="sectors-content">
                    <div class="sidebar-list">
                        <button class="sidebar-item" onclick="fillQuery('vulnerabilities affecting Chemical sector')">
                            <span class="item-emoji">üß™</span>
                            <span class="item-name">Chemical</span>
                        </button>
                        <button class="sidebar-item" onclick="fillQuery('vulnerabilities affecting Commercial Facilities')">
                            <span class="item-emoji">üè¨</span>
                            <span class="item-name">Commercial Facilities</span>
                        </button>
                        <button class="sidebar-item" onclick="fillQuery('vulnerabilities affecting Communications sector')">
                            <span class="item-emoji">üì°</span>
                            <span class="item-name">Communications</span>
                        </button>
                        <button class="sidebar-item" onclick="fillQuery('vulnerabilities affecting Critical Manufacturing')">
                            <span class="item-emoji">üè≠</span>
                            <span class="item-name">Critical Manufacturing</span>
                        </button>
                        <button class="sidebar-item" onclick="fillQuery('vulnerabilities affecting Dams sector')">
                            <span class="item-emoji">üåä</span>
                            <span class="item-name">Dams</span>
                        </button>
                        <button class="sidebar-item" onclick="fillQuery('vulnerabilities affecting Defense Industrial Base')">
                            <span class="item-emoji">üõ°Ô∏è</span>
                            <span class="item-name">Defense Industrial Base</span>
                        </button>
                        <button class="sidebar-item" onclick="fillQuery('vulnerabilities affecting Emergency Services')">
                            <span class="item-emoji">üö®</span>
                            <span class="item-name">Emergency Services</span>
                        </button>
                        <button class="sidebar-item" onclick="fillQuery('vulnerabilities affecting Energy sector')">
                            <span class="item-emoji">‚ö°</span>
                            <span class="item-name">Energy</span>
                        </button>
                        <button class="sidebar-item" onclick="fillQuery('vulnerabilities affecting Financial Services')">
                            <span class="item-emoji">üí∞</span>
                            <span class="item-name">Financial Services</span>
                        </button>
                        <button class="sidebar-item" onclick="fillQuery('vulnerabilities affecting Food and Agriculture')">
                            <span class="item-emoji">üåæ</span>
                            <span class="item-name">Food & Agriculture</span>
                        </button>
                        <button class="sidebar-item" onclick="fillQuery('vulnerabilities affecting Government Services')">
                            <span class="item-emoji">üèõÔ∏è</span>
                            <span class="item-name">Government Services</span>
                        </button>
                        <button class="sidebar-item" onclick="fillQuery('vulnerabilities affecting Healthcare')">
                            <span class="item-emoji">üè•</span>
                            <span class="item-name">Healthcare & Public Health</span>
                        </button>
                        <button class="sidebar-item" onclick="fillQuery('vulnerabilities affecting Information Technology')">
                            <span class="item-emoji">üíª</span>
                            <span class="item-name">Information Technology</span>
                        </button>
                        <button class="sidebar-item" onclick="fillQuery('vulnerabilities affecting Nuclear sector')">
                            <span class="item-emoji">‚ò¢Ô∏è</span>
                            <span class="item-name">Nuclear Reactors & Waste</span>
                        </button>
                        <button class="sidebar-item" onclick="fillQuery('vulnerabilities affecting Transportation')">
                            <span class="item-emoji">üöÇ</span>
                            <span class="item-name">Transportation Systems</span>
                        </button>
                        <button class="sidebar-item" onclick="fillQuery('vulnerabilities affecting Water and Wastewater')">
                            <span class="item-emoji">üíß</span>
                            <span class="item-name">Water & Wastewater</span>
                        </button>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Main Content Area -->
        <div class="main-content">
            <div class="main-card" id="main-card">
        <h1 class="welcome-title">Welcome to CyberIQ</h1>
        <p class="welcome-description">Triple-source intelligence: ZDI (earliest disclosures), NVD (newly published), and CISA KEVs (confirmed exploited). Get the earliest warning possible.</p>
        <div class="try-label">Try these:</div>
        <div class="suggestions">
            <button class="suggestion-btn" onclick="fillQuery('Latest zero-day vulnerabilities')">Latest Zero-Days</button>
            <button class="suggestion-btn" onclick="fillQuery('Microsoft vulnerabilities')">Microsoft</button>
            <button class="suggestion-btn" onclick="fillQuery('RCE vulnerabilities')">RCE Exploits</button>
            <button class="suggestion-btn" onclick="fillQuery('Top KEVs by CVSS')">Top KEVs</button>
            <button class="suggestion-btn" onclick="fillQuery('Ransomware KEVs')">Ransomware</button>
        </div>
        <div class="input-container">
            <input type="text" class="query-input" id="query-input" placeholder="Ask about threats..." onkeypress="if(event.key==='Enter')search()">
            <button class="send-btn" id="send-btn" onclick="search()">Send</button>
        </div>
    </div>
    
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p class="loading-text">Analyzing...</p>
    </div>
    
    <div class="results-container" id="results-container">
        <div class="results-header">
            <h2 class="results-title">Analysis Results</h2>
            <div class="header-actions">
                <div class="performance-badge" id="performance-badge"></div>
                <button class="generate-btn" onclick="exportCSV()" style="background: #10b981; margin-right: 10px;">üì• Export CSV</button>
                <button class="generate-btn" id="generate-btn" onclick="openQueryTab()">üîç Generate SIEM Queries</button>
            </div>
        </div>
        
        <div class="try-label" style="margin: 20px 0 15px 0; text-align: center;">Try these:</div>
        <div class="suggestions" style="margin-bottom: 30px;">
            <button class="suggestion-btn" onclick="fillQuery('Latest zero-day vulnerabilities')">Latest Zero-Days</button>
            <button class="suggestion-btn" onclick="fillQuery('Microsoft vulnerabilities')">Microsoft</button>
            <button class="suggestion-btn" onclick="fillQuery('RCE vulnerabilities')">RCE Exploits</button>
            <button class="suggestion-btn" onclick="fillQuery('Top KEVs by CVSS')">Top KEVs</button>
            <button class="suggestion-btn" onclick="fillQuery('Ransomware KEVs')">Ransomware</button>
        </div>
        
        <div class="results-content" id="results-content"></div>
        
        <!-- Pagination Controls -->
        <div class="pagination" id="pagination" style="display: none;">
            <button class="page-btn" id="prev-btn" onclick="changePage(-1)">‚Üê Previous</button>
            <span class="page-info" id="page-info">Page 1 of 1</span>
            <button class="page-btn" id="next-btn" onclick="changePage(1)">Next ‚Üí</button>
        </div>
        
        <div class="input-container" style="margin-top: 40px;">
            <input type="text" class="query-input" id="query-input-2" placeholder="Ask another question..." onkeypress="if(event.key==='Enter')search2()">
            <button class="send-btn" id="send-btn-2" onclick="search2()">Send</button>
        </div>
    </div>
    
    </div> <!-- Close main-content -->
    </div> <!-- Close layout-wrapper -->
    
    <script>
    let lastQuery = '';
    let currentPage = 1;
    let totalPages = 1;
    
    // Mobile Sidebar Toggle
    function toggleSidebar() {
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.querySelector('.sidebar-overlay');
        sidebar.classList.toggle('open');
        overlay.classList.toggle('active');
    }
    
    function closeSidebar() {
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.querySelector('.sidebar-overlay');
        sidebar.classList.remove('open');
        overlay.classList.remove('active');
    }
    
    // Toggle collapsible sidebar sections
    function toggleSection(sectionId) {
        const content = document.getElementById(`${sectionId}-content`);
        const arrow = document.getElementById(`${sectionId}-arrow`);
        
        if (content.classList.contains('open')) {
            content.classList.remove('open');
            arrow.classList.remove('open');
        } else {
            content.classList.add('open');
            arrow.classList.add('open');
        }
    }
    
    // Close sidebar when clicking a vendor (mobile)
    function fillQuery(text) {
        document.getElementById('query-input').value = text;
        document.getElementById('query-input-2').value = text;
        
        // Close sidebar on mobile after selection
        if (window.innerWidth <= 768) {
            closeSidebar();
        }
    }
    
    // Fetch and display current stats on page load
    async function fetchStats() {
        try {
            const response = await fetch('/api/status');
            const data = await response.json();
            
            if (data.status === 'online') {
                document.getElementById('stat-zdi').textContent = data.data.zdi_advisories.toLocaleString();
                document.getElementById('stat-nvd').textContent = data.data.recent_nvd_cves.toLocaleString();
                document.getElementById('stat-kevs').textContent = data.data.cisa_kevs.toLocaleString();
                document.getElementById('stat-total').textContent = data.data.total.toLocaleString();
            }
        } catch (error) {
            console.error('Error fetching stats:', error);
            // Keep default values on error
        }
    }
    
    // Load stats on page load
    fetchStats();
    
    // Fetch and display top vendors
    async function fetchVendorStats() {
        try {
            const response = await fetch('/api/vendor-stats');
            const data = await response.json();
            
            const vendorList = document.getElementById('vendor-list');
            if (data.top_vendors && data.top_vendors.length > 0) {
                vendorList.innerHTML = data.top_vendors.map(v => 
                    `<button class="vendor-item" onclick="fillQuery('${v.vendor} vulnerabilities')">
                        <span class="vendor-name">${v.vendor}</span>
                        <span class="vendor-count">${v.count}</span>
                        <span class="vendor-arrow">‚Üí</span>
                    </button>`
                ).join('');
            }
        } catch (error) {
            console.error('Error fetching vendor stats:', error);
        }
    }
    
    // Load vendor stats on page load
    fetchVendorStats();
    
    // Export current results to CSV
    async function exportCSV() {
        try {
            const query = lastQuery || document.getElementById('query-input-2').value;
            if (!query) {
                alert('No query to export');
                return;
            }
            
            const response = await fetch('/api/export-csv', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    vendor: '',
                    date_filter: '',
                    query: query
                })
            });
            
            const data = await response.json();
            
            // Create download link with UTF-8 encoding
            const blob = new Blob([data.csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cyberiq_export_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert(`Exported ${data.count} vulnerabilities to CSV!`);
        } catch (error) {
            console.error('Error exporting CSV:', error);
            alert('Error exporting CSV. Please try again.');
        }
    }
    
    async function search() {
        const query = document.getElementById('query-input').value.trim();
        if (!query) { alert('Please enter a query'); return; }
        
        lastQuery = query;
        currentPage = 1; // Reset to first page
        document.getElementById('main-card').style.display = 'none';
        document.getElementById('loading').style.display = 'block';
        document.getElementById('results-container').style.display = 'none';
        document.getElementById('send-btn').disabled = true;
        
        const startTime = Date.now();
        
        try {
            const response = await fetch('/api/query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    query: query, 
                    vendor: '', 
                    date_filter: '',
                    page: currentPage,
                    per_page: 10
                })
            });
            
            if (!response.ok) throw new Error('Query failed');
            
            const data = await response.json();
            const duration = ((Date.now() - startTime) / 1000).toFixed(1);
            
            // Update pagination state
            totalPages = data.total_pages || 1;
            currentPage = data.current_page || 1;
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results-container').style.display = 'block';
            document.getElementById('send-btn').disabled = false;
            document.getElementById('performance-badge').textContent = '‚ö° ' + duration + 's';
            
            let html = data.response;
            
            // DON'T process HTML responses - they're already formatted!
            if (!html.includes('<table')) {
                // Only convert newlines for plain text
                html = html.replace(/\n/g, '<br>');
            }
            
            document.getElementById('results-content').innerHTML = html;
            
            // Update pagination UI
            updatePaginationUI(data.total_count);
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('main-card').style.display = 'block';
            document.getElementById('send-btn').disabled = false;
            alert('Error analyzing query');
        }
    }
    
    async function search2() {
        const query = document.getElementById('query-input-2').value.trim();
        if (!query) { alert('Please enter a query'); return; }
        
        lastQuery = query;
        currentPage = 1; // Reset to first page
        document.getElementById('loading').style.display = 'block';
        document.getElementById('results-container').style.display = 'none';
        document.getElementById('send-btn-2').disabled = true;
        
        const startTime = Date.now();
        
        try {
            const response = await fetch('/api/query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    query: query, 
                    vendor: '', 
                    date_filter: '',
                    page: currentPage,
                    per_page: 10
                })
            });
            
            if (!response.ok) throw new Error('Query failed');
            
            const data = await response.json();
            const duration = ((Date.now() - startTime) / 1000).toFixed(1);
            
            // Update pagination state
            totalPages = data.total_pages || 1;
            currentPage = data.current_page || 1;
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results-container').style.display = 'block';
            document.getElementById('send-btn-2').disabled = false;
            document.getElementById('performance-badge').textContent = '‚ö° ' + duration + 's';
            
            let html = data.response;
            
            // DON'T process HTML responses - they're already formatted!
            if (!html.includes('<table')) {
                // Only convert newlines for plain text
                html = html.replace(/\n/g, '<br>');
            }
            
            document.getElementById('results-content').innerHTML = html;
            
            // Update pagination UI
            updatePaginationUI(data.total_count);
            
            document.getElementById('query-input-2').value = ''; // Clear input
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results-container').style.display = 'block';
            document.getElementById('send-btn-2').disabled = false;
            alert('Error analyzing query');
        }
    }
    
    function updatePaginationUI(totalCount) {
        const pagination = document.getElementById('pagination');
        const pageInfo = document.getElementById('page-info');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        
        if (totalPages > 1) {
            pagination.style.display = 'flex';
            pageInfo.textContent = `Page ${currentPage} of ${totalPages} (${totalCount} total results)`;
            prevBtn.disabled = (currentPage === 1);
            nextBtn.disabled = (currentPage === totalPages);
        } else {
            pagination.style.display = 'none';
        }
    }
    
    async function changePage(direction) {
        const newPage = currentPage + direction;
        if (newPage < 1 || newPage > totalPages) return;
        
        currentPage = newPage;
        
        // Re-run query with new page
        document.getElementById('loading').style.display = 'block';
        document.getElementById('results-container').style.display = 'none';
        
        const startTime = Date.now();
        
        try {
            const response = await fetch('/api/query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    query: lastQuery, 
                    vendor: '', 
                    date_filter: '',
                    page: currentPage,
                    per_page: 10
                })
            });
            
            if (!response.ok) throw new Error('Query failed');
            
            const data = await response.json();
            const duration = ((Date.now() - startTime) / 1000).toFixed(1);
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results-container').style.display = 'block';
            document.getElementById('performance-badge').textContent = '‚ö° ' + duration + 's';
            
            let html = data.response;
            if (!html.includes('<table')) {
                html = html.replace(/\n/g, '<br>');
            }
            
            document.getElementById('results-content').innerHTML = html;
            updatePaginationUI(data.total_count);
            
            // Scroll to top of results
            document.getElementById('results-container').scrollIntoView({ behavior: 'smooth' });
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results-container').style.display = 'block';
            alert('Error loading page');
        }
    }
    
    function openQueryTab() {
        if (!lastQuery) { alert('Please run a query first'); return; }
        
        const tab = window.open('', '_blank');
        const doc = tab.document;
        
        doc.open();
        doc.write('<!DOCTYPE html><html><head><meta charset="UTF-8"><title>SIEM Queries</title>');
        doc.write('<style>');
        doc.write('* { margin: 0; padding: 0; box-sizing: border-box; }');
        doc.write('body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:40px 20px}');
        doc.write('.header{text-align:center;color:white;margin-bottom:40px}');
        doc.write('h1{font-size:36px;font-weight:700;margin-bottom:10px}');
        doc.write('.subtitle{font-size:16px;opacity:0.95;margin-bottom:40px}');
        doc.write('.buttons{display:flex;gap:15px;justify-content:center;margin-bottom:30px;flex-wrap:wrap}');
        doc.write('button{background:rgba(255,255,255,0.95);color:#667eea;border:none;padding:15px 30px;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.2s;box-shadow:0 4px 15px rgba(0,0,0,0.2)}');
        doc.write('button:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.3);background:white}');
        doc.write('button:disabled{background:#cbd5e0;color:#718096;cursor:not-allowed;box-shadow:none}');
        doc.write('.result{background:white;padding:40px;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);max-width:1000px;margin:0 auto;display:none}');
        doc.write('.result.show{display:block}');
        doc.write('.query-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}');
        doc.write('h2{color:#667eea;margin:0;font-size:24px}');
        doc.write('.copy{background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;transition:transform 0.2s}');
        doc.write('.copy:hover{transform:translateY(-2px)}');
        doc.write('.copy.copied{background:#48bb78}');
        doc.write('pre{background:#1e1e1e;color:#d4d4d4;padding:20px;border-radius:8px;overflow-x:auto;font-size:13px;line-height:1.6;white-space:pre-wrap;margin:0}');
        doc.write('.loading{text-align:center;padding:60px;color:white;display:none}');
        doc.write('.loading.show{display:block}');
        doc.write('.spinner{border:4px solid rgba(255,255,255,0.3);border-top:4px solid white;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 20px}');
        doc.write('@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}');
        doc.write('.loading-text{font-size:16px}');
        doc.write('</style></head><body>');
        doc.write('<div class="header">');
        doc.write('<h1>üîç SIEM Detection Queries</h1>');
        doc.write('<p class="subtitle">Select which query type to generate:</p>');
        doc.write('</div>');
        doc.write('<div class="buttons">');
        doc.write('<button onclick="gen(\'kql\')">Azure Sentinel (KQL)</button>');
        doc.write('<button onclick="gen(\'spl\')">Splunk (SPL)</button>');
        doc.write('<button onclick="gen(\'eql\')">Elasticsearch (EQL)</button>');
        doc.write('</div>');
        doc.write('<div class="loading" id="load"><div class="spinner"></div><p class="loading-text">Generating query...</p></div>');
        doc.write('<div class="result" id="res"><div class="query-header"><h2 id="title"></h2><button class="copy" onclick="cp()">üìã Copy</button></div><pre id="code"></pre></div>');
        doc.write('<script>');
        doc.write('let q="";');
        doc.write('let uq=' + JSON.stringify(lastQuery) + ';');
        doc.write('async function gen(t){');
        doc.write('const ts={kql:"Azure Sentinel (KQL)",spl:"Splunk (SPL)",eql:"Elasticsearch (EQL)"};');
        doc.write('document.getElementById("load").classList.add("show");');
        doc.write('document.getElementById("res").classList.remove("show");');
        doc.write('document.querySelectorAll("button").forEach(b=>b.disabled=true);');
        doc.write('try{');
        doc.write('const r=await fetch(opener.location.origin+"/api/generate-single-query",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query_type:t,query:uq})});');
        doc.write('if(!r.ok)throw new Error("Failed");');
        doc.write('const d=await r.json();');
        doc.write('q=d.query;');
        doc.write('document.getElementById("load").classList.remove("show");');
        doc.write('document.getElementById("res").classList.add("show");');
        doc.write('document.getElementById("title").textContent=ts[t];');
        doc.write('document.getElementById("code").textContent=q;');
        doc.write('}catch(e){alert("Error: "+e.message)}finally{document.querySelectorAll("button").forEach(b=>b.disabled=false)}');
        doc.write('}');
        doc.write('function cp(){navigator.clipboard.writeText(q).then(()=>{const b=document.querySelector(".copy");const o=b.textContent;b.textContent="‚úÖ Copied!";b.classList.add("copied");setTimeout(()=>{b.textContent=o;b.classList.remove("copied")},2000)})}');
        doc.write('</' + 'script></body></html>');
        doc.close();
    }
    </script>
</body>
</html>
