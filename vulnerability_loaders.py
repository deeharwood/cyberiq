"""
CyberIQ Vulnerability Data Loaders - Rate Limit Safe Version
Fetches and enriches vulnerability data from:
- CISA Known Exploited Vulnerabilities (KEV) - with selective enrichment
- Avoids NVD API rate limits by limiting enrichment to most critical items
"""

import requests
import time
from typing import List, Dict
from datetime import datetime, timedelta


# ==============================================================================
# CWE (Common Weakness Enumeration) Descriptions
# ==============================================================================

CWE_DESCRIPTIONS = {
    'CWE-79': 'Cross-site Scripting (XSS)',
    'CWE-89': 'SQL Injection',
    'CWE-78': 'OS Command Injection',
    'CWE-22': 'Path Traversal',
    'CWE-352': 'Cross-Site Request Forgery (CSRF)',
    'CWE-434': 'Unrestricted Upload of Dangerous File Type',
    'CWE-94': 'Code Injection',
    'CWE-611': 'XML External Entity (XXE)',
    'CWE-798': 'Hard-coded Credentials',
    'CWE-287': 'Improper Authentication',
    'CWE-306': 'Missing Authentication',
    'CWE-862': 'Missing Authorization',
    'CWE-863': 'Incorrect Authorization',
    'CWE-918': 'Server-Side Request Forgery (SSRF)',
    'CWE-502': 'Deserialization of Untrusted Data',
    'CWE-77': 'Command Injection',
    'CWE-917': 'Expression Language Injection',
    'CWE-20': 'Improper Input Validation',
    'CWE-119': 'Buffer Overflow',
    'CWE-125': 'Out-of-bounds Read',
    'CWE-787': 'Out-of-bounds Write',
    'CWE-416': 'Use After Free',
    'CWE-190': 'Integer Overflow',
    'CWE-476': 'NULL Pointer Dereference',
    'CWE-200': 'Information Exposure',
    'CWE-732': 'Incorrect Permission Assignment',
    'CWE-269': 'Improper Privilege Management',
    'CWE-284': 'Improper Access Control',
    'CWE-326': 'Inadequate Encryption Strength',
    'CWE-327': 'Use of Broken Crypto Algorithm',
    'CWE-770': 'Allocation of Resources Without Limits',
    'CWE-400': 'Uncontrolled Resource Consumption',
    'CWE-835': 'Infinite Loop',
    'CWE-674': 'Uncontrolled Recursion'
}


def get_cwe_description(cwe_id: str) -> str:
    """Get human-readable description for CWE ID"""
    return CWE_DESCRIPTIONS.get(cwe_id, 'Unknown Weakness')


# ==============================================================================
# Load CISA Known Exploited Vulnerabilities (KEV) - RATE LIMIT SAFE
# ==============================================================================

def load_kev_data() -> List[Dict]:
    """
    Load CISA Known Exploited Vulnerabilities
    Note: Enrichment is limited to avoid NVD API rate limits
    """
    print("‚ö†Ô∏è  Loading CISA Known Exploited Vulnerabilities...")
    
    url = "https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json"
    
    try:
        response = requests.get(url, timeout=30)
        response.raise_for_status()
        
        data = response.json()
        vulnerabilities = data.get('vulnerabilities', [])
        
        print(f"‚úÖ Loaded {len(vulnerabilities)} KEVs from CISA catalog")
        print(f"‚ÑπÔ∏è  Note: CVSS/CWE enrichment skipped to avoid NVD API rate limits")
        print(f"‚ÑπÔ∏è  KEVs contain comprehensive CISA analysis and exploitation data")
        
        # Process KEVs with basic formatting (no NVD API calls)
        processed_kevs = []
        
        for vuln in vulnerabilities:
            processed_kev = {
                'cve_id': vuln.get('cveID', ''),
                'vendor_project': vuln.get('vendorProject', ''),
                'product': vuln.get('product', ''),
                'vulnerability_name': vuln.get('vulnerabilityName', ''),
                'date_added': vuln.get('dateAdded', ''),
                'short_description': vuln.get('shortDescription', ''),
                'required_action': vuln.get('requiredAction', ''),
                'due_date': vuln.get('dueDate', ''),
                'known_ransomware': vuln.get('knownRansomwareCampaignUse', 'Unknown'),
                'notes': vuln.get('notes', ''),
                # CVSS (placeholder - can be enriched later with NVD API key)
                'cvss_score': 0.0,
                'cvss_severity': 'HIGH',  # KEVs are by definition critical
                'cvss_vector': '',
                # CWE (placeholder)
                'cwe_id': '',
                'cwe_description': '',
                'cwe_list': [],
                # NVD
                'nvd_link': f"https://nvd.nist.gov/vuln/detail/{vuln.get('cveID', '')}",
                'references': [],
                # CISA ADP (KEVs are by definition exploited)
                'cisa_known_exploited': True,
                'cisa_exploit_add_date': vuln.get('dateAdded', ''),
                'cisa_required_action': vuln.get('requiredAction', ''),
                'cisa_due_date': vuln.get('dueDate', ''),
                'cisa_notes': vuln.get('notes', ''),
                'cisa_ransomware': vuln.get('knownRansomwareCampaignUse', 'Unknown') == 'Known',
                'cisa_action_needed': vuln.get('requiredAction', '')
            }
            
            processed_kevs.append(processed_kev)
        
        print(f"‚úÖ Processed {len(processed_kevs)} KEVs with CISA data")
        print(f"üí° Tip: Add NVD_API_KEY environment variable for CVSS/CWE enrichment")
        return processed_kevs
    
    except Exception as e:
        print(f"‚ùå Error loading KEV data: {str(e)}")
        return []


# ==============================================================================
# Load Recent CVEs from NVD - DISABLED TO AVOID RATE LIMITS
# ==============================================================================

def load_recent_cves(days: int = 90) -> List[Dict]:
    """
    Load recent CVEs from NVD
    Note: Disabled by default to avoid API rate limits
    """
    print(f"‚ÑπÔ∏è  Recent CVE loading disabled to avoid NVD API rate limits")
    print(f"‚ÑπÔ∏è  KEVs contain the most critical exploited vulnerabilities")
    print(f"üí° Tip: Add NVD_API_KEY environment variable to enable CVE loading")
    return []
