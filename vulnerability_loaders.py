"""
CyberIQ Vulnerability Data Loaders
Fetches and enriches vulnerability data from:
- CISA Known Exploited Vulnerabilities (KEV)
- NVD CVE Database
- Includes: CVSS scores, CWE classifications, NVD links, CISA ADP data
"""

import requests
import time
from typing import List, Dict
from datetime import datetime, timedelta


# ==============================================================================
# CWE (Common Weakness Enumeration) Descriptions
# ==============================================================================

CWE_DESCRIPTIONS = {
    'CWE-79': 'Cross-site Scripting (XSS)',
    'CWE-89': 'SQL Injection',
    'CWE-78': 'OS Command Injection',
    'CWE-22': 'Path Traversal',
    'CWE-352': 'Cross-Site Request Forgery (CSRF)',
    'CWE-434': 'Unrestricted Upload of Dangerous File Type',
    'CWE-94': 'Code Injection',
    'CWE-611': 'XML External Entity (XXE)',
    'CWE-798': 'Hard-coded Credentials',
    'CWE-287': 'Improper Authentication',
    'CWE-306': 'Missing Authentication',
    'CWE-862': 'Missing Authorization',
    'CWE-863': 'Incorrect Authorization',
    'CWE-918': 'Server-Side Request Forgery (SSRF)',
    'CWE-502': 'Deserialization of Untrusted Data',
    'CWE-77': 'Command Injection',
    'CWE-917': 'Expression Language Injection',
    'CWE-20': 'Improper Input Validation',
    'CWE-119': 'Buffer Overflow',
    'CWE-125': 'Out-of-bounds Read',
    'CWE-787': 'Out-of-bounds Write',
    'CWE-416': 'Use After Free',
    'CWE-190': 'Integer Overflow',
    'CWE-476': 'NULL Pointer Dereference',
    'CWE-200': 'Information Exposure',
    'CWE-732': 'Incorrect Permission Assignment',
    'CWE-269': 'Improper Privilege Management',
    'CWE-284': 'Improper Access Control',
    'CWE-326': 'Inadequate Encryption Strength',
    'CWE-327': 'Use of Broken Crypto Algorithm',
    'CWE-770': 'Allocation of Resources Without Limits',
    'CWE-400': 'Uncontrolled Resource Consumption',
    'CWE-835': 'Infinite Loop',
    'CWE-674': 'Uncontrolled Recursion'
}


def get_cwe_description(cwe_id: str) -> str:
    """Get human-readable description for CWE ID"""
    return CWE_DESCRIPTIONS.get(cwe_id, 'Unknown Weakness')


# ==============================================================================
# NVD API Functions - Fetch Vulnerability Details
# ==============================================================================

def extract_cisa_adp(cve_data: dict) -> Dict:
    """
    Extract CISA ADP (Authorized Data Publisher) information from CVE data
    CISA provides additional analysis and context for vulnerabilities
    """
    cisa_info = {
        'known_exploited': False,
        'exploit_add_date': '',
        'required_action': '',
        'due_date': '',
        'notes': '',
        'ransomware': False,
        'action_needed': ''
    }
    
    try:
        # Check for CISA container data in CVE JSON
        if 'containers' in cve_data:
            containers = cve_data['containers']
            
            # Look for CISA-ADP container
            if 'cisa.gov' in containers or 'adp' in containers:
                cisa_container = containers.get('cisa.gov', containers.get('adp', {}))
                
                # Extract CISA-specific data
                if 'providerMetadata' in cisa_container:
                    provider = cisa_container['providerMetadata']
                    if 'cisa.gov' in provider.get('orgId', '').lower():
                        metrics = cisa_container.get('metrics', [])
                        for metric in metrics:
                            if 'other' in metric:
                                other_data = metric['other']
                                cisa_info['action_needed'] = other_data.get('content', '')
                
                # Check for KEV catalog reference
                if 'x_KEV' in cisa_container or 'known_exploited' in cisa_container:
                    cisa_info['known_exploited'] = True
                
                # Extract timeline data
                if 'dateAdded' in cisa_container:
                    cisa_info['exploit_add_date'] = cisa_container['dateAdded']
                
                if 'dueDate' in cisa_container:
                    cisa_info['due_date'] = cisa_container['dueDate']
                
                if 'requiredAction' in cisa_container:
                    cisa_info['required_action'] = cisa_container['requiredAction']
                
                # Check ransomware flag
                if 'knownRansomwareCampaignUse' in cisa_container:
                    cisa_info['ransomware'] = cisa_container['knownRansomwareCampaignUse'] == 'Known'
                
                if 'notes' in cisa_container:
                    cisa_info['notes'] = cisa_container['notes']
        
        # Also check references for CISA KEV catalog
        references = cve_data.get('references', [])
        for ref in references:
            url = ref.get('url', '')
            tags = ref.get('tags', [])
            
            # If reference points to CISA KEV catalog
            if 'cisa.gov' in url.lower() and 'known-exploited' in url.lower():
                cisa_info['known_exploited'] = True
            
            # Check tags for CISA indicators
            if any(tag.lower() in ['exploit', 'known-exploited'] for tag in tags):
                source = ref.get('source', '')
                if 'cisa' in source.lower():
                    cisa_info['known_exploited'] = True
    
    except Exception as e:
        print(f"Error extracting CISA ADP data: {str(e)}")
    
    return cisa_info


def fetch_vulnerability_details(cve_id: str) -> Dict:
    """
    Fetch comprehensive vulnerability details from NVD API
    Returns: CVSS, CWE, NVD link, CISA ADP data, and references
    """
    try:
        url = f"https://services.nvd.nist.gov/rest/json/cves/2.0?cveId={cve_id}"
        headers = {'User-Agent': 'CyberIQ/1.0'}
        
        response = requests.get(url, headers=headers, timeout=10)
        
        if response.status_code == 200:
            data = response.json()
            
            if 'vulnerabilities' in data and len(data['vulnerabilities']) > 0:
                vuln = data['vulnerabilities'][0]
                cve = vuln.get('cve', {})
                metrics = cve.get('metrics', {})
                
                # ============================================================
                # Extract CVSS (Common Vulnerability Scoring System)
                # ============================================================
                cvss_score = 0.0
                cvss_severity = 'UNKNOWN'
                cvss_vector = ''
                
                # Try CVSS v3.1 first (most common)
                if 'cvssMetricV31' in metrics and len(metrics['cvssMetricV31']) > 0:
                    cvss_data = metrics['cvssMetricV31'][0]['cvssData']
                    cvss_score = cvss_data.get('baseScore', 0.0)
                    cvss_severity = cvss_data.get('baseSeverity', 'UNKNOWN')
                    cvss_vector = cvss_data.get('vectorString', '')
                
                # Try CVSS v3.0
                elif 'cvssMetricV30' in metrics and len(metrics['cvssMetricV30']) > 0:
                    cvss_data = metrics['cvssMetricV30'][0]['cvssData']
                    cvss_score = cvss_data.get('baseScore', 0.0)
                    cvss_severity = cvss_data.get('baseSeverity', 'UNKNOWN')
                    cvss_vector = cvss_data.get('vectorString', '')
                
                # Fallback to CVSS v2
                elif 'cvssMetricV2' in metrics and len(metrics['cvssMetricV2']) > 0:
                    cvss_data = metrics['cvssMetricV2'][0]['cvssData']
                    cvss_score = cvss_data.get('baseScore', 0.0)
                    # Map v2 score to v3 severity
                    if cvss_score >= 7.0:
                        cvss_severity = 'HIGH'
                    elif cvss_score >= 4.0:
                        cvss_severity = 'MEDIUM'
                    else:
                        cvss_severity = 'LOW'
                    cvss_vector = cvss_data.get('vectorString', '')
                
                # ============================================================
                # Extract CWE (Common Weakness Enumeration)
                # ============================================================
                cwes = []
                weaknesses = cve.get('weaknesses', [])
                for weakness in weaknesses:
                    for desc in weakness.get('description', []):
                        cwe_value = desc.get('value', '')
                        if cwe_value.startswith('CWE-'):
                            cwes.append(cwe_value)
                
                primary_cwe = cwes[0] if cwes else ''
                
                # ============================================================
                # Extract CISA ADP Data
                # ============================================================
                cisa_adp_data = extract_cisa_adp(cve)
                
                # ============================================================
                # NVD Link and References
                # ============================================================
                nvd_link = f"https://nvd.nist.gov/vuln/detail/{cve_id}"
                
                references = []
                refs = cve.get('references', [])
                for ref in refs[:5]:  # Limit to first 5 references
                    references.append({
                        'url': ref.get('url', ''),
                        'source': ref.get('source', ''),
                        'tags': ref.get('tags', [])
                    })
                
                return {
                    # CVSS
                    'cvss_score': cvss_score,
                    'cvss_severity': cvss_severity,
                    'cvss_vector': cvss_vector,
                    # CWE
                    'cwe_id': primary_cwe,
                    'cwe_list': cwes,
                    # NVD
                    'nvd_link': nvd_link,
                    'references': references,
                    # CISA ADP
                    'cisa_known_exploited': cisa_adp_data['known_exploited'],
                    'cisa_exploit_add_date': cisa_adp_data['exploit_add_date'],
                    'cisa_required_action': cisa_adp_data['required_action'],
                    'cisa_due_date': cisa_adp_data['due_date'],
                    'cisa_notes': cisa_adp_data['notes'],
                    'cisa_ransomware': cisa_adp_data['ransomware'],
                    'cisa_action_needed': cisa_adp_data['action_needed']
                }
        
        # No data found - return defaults
        return _get_default_vuln_details(cve_id)
    
    except Exception as e:
        print(f"Error fetching details for {cve_id}: {str(e)}")
        return _get_default_vuln_details(cve_id)


def _get_default_vuln_details(cve_id: str) -> Dict:
    """Return default/empty vulnerability details"""
    return {
        'cvss_score': 0.0,
        'cvss_severity': 'UNKNOWN',
        'cvss_vector': '',
        'cwe_id': '',
        'cwe_list': [],
        'nvd_link': f"https://nvd.nist.gov/vuln/detail/{cve_id}",
        'references': [],
        'cisa_known_exploited': False,
        'cisa_exploit_add_date': '',
        'cisa_required_action': '',
        'cisa_due_date': '',
        'cisa_notes': '',
        'cisa_ransomware': False,
        'cisa_action_needed': ''
    }


# ==============================================================================
# Load CISA Known Exploited Vulnerabilities (KEV)
# ==============================================================================

def load_kev_data() -> List[Dict]:
    """
    Load CISA Known Exploited Vulnerabilities with full enrichment:
    - CVSS scores
    - CWE classifications
    - NVD links
    - CISA ADP data
    """
    print("‚ö†Ô∏è  Loading CISA Known Exploited Vulnerabilities...")
    
    url = "https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json"
    
    try:
        response = requests.get(url, timeout=30)
        response.raise_for_status()
        
        data = response.json()
        vulnerabilities = data.get('vulnerabilities', [])
        
        print(f"‚úÖ Loaded {len(vulnerabilities)} KEVs from CISA catalog")
        print(f"üîç Enriching with CVSS, CWE, NVD, and CISA ADP data...")
        
        enriched_kevs = []
        
        for i, vuln in enumerate(vulnerabilities):
            cve_id = vuln.get('cveID', '')
            
            # Progress indicator (with rate limiting)
            if i > 0 and i % 50 == 0:
                print(f"   Processing... {i}/{len(vulnerabilities)}")
                time.sleep(1)  # Rate limit to avoid overwhelming NVD API
            
            # Fetch comprehensive details including CISA ADP
            details = fetch_vulnerability_details(cve_id)
            
            enriched_kev = {
                'cve_id': cve_id,
                'vendor_project': vuln.get('vendorProject', ''),
                'product': vuln.get('product', ''),
                'vulnerability_name': vuln.get('vulnerabilityName', ''),
                'date_added': vuln.get('dateAdded', ''),
                'short_description': vuln.get('shortDescription', ''),
                'required_action': vuln.get('requiredAction', ''),
                'due_date': vuln.get('dueDate', ''),
                'known_ransomware': vuln.get('knownRansomwareCampaignUse', 'Unknown'),
                'notes': vuln.get('notes', ''),
                # CVSS
                'cvss_score': details['cvss_score'],
                'cvss_severity': details['cvss_severity'],
                'cvss_vector': details['cvss_vector'],
                # CWE
                'cwe_id': details['cwe_id'],
                'cwe_description': get_cwe_description(details['cwe_id']),
                'cwe_list': details['cwe_list'],
                # NVD
                'nvd_link': details['nvd_link'],
                'references': details['references'],
                # CISA ADP (KEVs are by definition exploited)
                'cisa_known_exploited': True,
                'cisa_exploit_add_date': details['cisa_exploit_add_date'] or vuln.get('dateAdded', ''),
                'cisa_required_action': details['cisa_required_action'] or vuln.get('requiredAction', ''),
                'cisa_due_date': details['cisa_due_date'] or vuln.get('dueDate', ''),
                'cisa_notes': details['cisa_notes'] or vuln.get('notes', ''),
                'cisa_ransomware': vuln.get('knownRansomwareCampaignUse', 'Unknown') == 'Known',
                'cisa_action_needed': details['cisa_action_needed']
            }
            
            enriched_kevs.append(enriched_kev)
        
        print(f"‚úÖ Enriched {len(enriched_kevs)} KEVs with CVSS, CWE, NVD, and CISA ADP data")
        return enriched_kevs
    
    except Exception as e:
        print(f"‚ùå Error loading KEV data: {str(e)}")
        return []


# ==============================================================================
# Load Recent CVEs from NVD
# ==============================================================================

def load_recent_cves(days: int = 90) -> List[Dict]:
    """
    Load recent CVEs from NVD with full enrichment:
    - CVSS scores
    - CWE classifications  
    - NVD links
    - CISA ADP data (if available)
    """
    print(f"üîí Loading Recent CVEs from last {days} days...")
    
    end_date = datetime.now()
    start_date = end_date - timedelta(days=days)
    
    # Format dates for NVD API
    pub_start = start_date.strftime('%Y-%m-%dT00:00:00.000')
    pub_end = end_date.strftime('%Y-%m-%dT23:59:59.999')
    
    url = "https://services.nvd.nist.gov/rest/json/cves/2.0"
    
    params = {
        'pubStartDate': pub_start,
        'pubEndDate': pub_end,
        'resultsPerPage': 2000
    }
    
    headers = {'User-Agent': 'CyberIQ/1.0'}
    
    try:
        print(f"üì• Downloading CVEs from {start_date.strftime('%Y-%m-%d')} to {end_date.strftime('%Y-%m-%d')}...")
        
        response = requests.get(url, params=params, headers=headers, timeout=60)
        response.raise_for_status()
        
        data = response.json()
        vulnerabilities = data.get('vulnerabilities', [])
        
        print(f"‚úÖ Downloaded {len(vulnerabilities)} CVEs")
        print(f"üîç Extracting CVSS, CWE, NVD, and CISA ADP data...")
        
        processed_cves = []
        
        for vuln_data in vulnerabilities:
            cve = vuln_data.get('cve', {})
            cve_id = cve.get('id', '')
            
            # Extract CVSS
            metrics = cve.get('metrics', {})
            cvss_score = 0.0
            cvss_severity = 'UNKNOWN'
            cvss_vector = ''
            
            # Try CVSS v3.1
            if 'cvssMetricV31' in metrics and len(metrics['cvssMetricV31']) > 0:
                cvss_data = metrics['cvssMetricV31'][0]['cvssData']
                cvss_score = cvss_data.get('baseScore', 0.0)
                cvss_severity = cvss_data.get('baseSeverity', 'UNKNOWN')
                cvss_vector = cvss_data.get('vectorString', '')
            
            # Try CVSS v3.0
            elif 'cvssMetricV30' in metrics and len(metrics['cvssMetricV30']) > 0:
                cvss_data = metrics['cvssMetricV30'][0]['cvssData']
                cvss_score = cvss_data.get('baseScore', 0.0)
                cvss_severity = cvss_data.get('baseSeverity', 'UNKNOWN')
                cvss_vector = cvss_data.get('vectorString', '')
            
            # Fallback to CVSS v2
            elif 'cvssMetricV2' in metrics and len(metrics['cvssMetricV2']) > 0:
                cvss_data = metrics['cvssMetricV2'][0]['cvssData']
                cvss_score = cvss_data.get('baseScore', 0.0)
                # Map v2 to v3 severity
                if cvss_score >= 7.0:
                    cvss_severity = 'HIGH'
                elif cvss_score >= 4.0:
                    cvss_severity = 'MEDIUM'
                else:
                    cvss_severity = 'LOW'
                cvss_vector = cvss_data.get('vectorString', '')
            
            # Extract CWE
            cwes = []
            weaknesses = cve.get('weaknesses', [])
            for weakness in weaknesses:
                for desc in weakness.get('description', []):
                    cwe_value = desc.get('value', '')
                    if cwe_value.startswith('CWE-'):
                        cwes.append(cwe_value)
            
            primary_cwe = cwes[0] if cwes else ''
            
            # Extract description
            descriptions = cve.get('descriptions', [])
            description = ''
            for desc in descriptions:
                if desc.get('lang') == 'en':
                    description = desc.get('value', '')
                    break
            
            # Published date
            published = cve.get('published', '')
            
            # NVD link
            nvd_link = f"https://nvd.nist.gov/vuln/detail/{cve_id}"
            
            # References
            references = []
            refs = cve.get('references', [])
            for ref in refs[:5]:
                references.append({
                    'url': ref.get('url', ''),
                    'source': ref.get('source', ''),
                    'tags': ref.get('tags', [])
                })
            
            # Extract CISA ADP data
            cisa_adp = extract_cisa_adp(cve)
            
            processed_cve = {
                'cve_id': cve_id,
                'description': description,
                'published_date': published,
                # CVSS
                'cvss_score': cvss_score,
                'cvss_severity': cvss_severity,
                'cvss_vector': cvss_vector,
                # CWE
                'cwe_id': primary_cwe,
                'cwe_description': get_cwe_description(primary_cwe),
                'cwe_list': cwes,
                # NVD
                'nvd_link': nvd_link,
                'references': references,
                # CISA ADP
                'cisa_known_exploited': cisa_adp['known_exploited'],
                'cisa_exploit_add_date': cisa_adp['exploit_add_date'],
                'cisa_required_action': cisa_adp['required_action'],
                'cisa_due_date': cisa_adp['due_date'],
                'cisa_notes': cisa_adp['notes'],
                'cisa_ransomware': cisa_adp['ransomware'],
                'cisa_action_needed': cisa_adp['action_needed']
            }
            
            processed_cves.append(processed_cve)
        
        print(f"‚úÖ Processed {len(processed_cves)} CVEs with full enrichment")
        return processed_cves
    
    except Exception as e:
        print(f"‚ùå Error loading CVE data: {str(e)}")
        return []
