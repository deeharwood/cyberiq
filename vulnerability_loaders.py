"""
CVE Data Loader - National Vulnerability Database (NVD)
Downloads and parses CVE data for vulnerability management
"""

import requests
import json
from typing import List, Dict
from datetime import datetime, timedelta


class CVEDataLoader:
    """Handles downloading and parsing CVE data from NVD"""
    
    def __init__(self):
        self.nvd_url = "https://services.nvd.nist.gov/rest/json/cves/2.0"
        
    def download_recent_cves(self, days: int = 90) -> Dict:
        """
        Download recent CVEs from NVD API
        
        Args:
            days: Number of days to look back (default 90)
        
        Returns:
            Dict of CVE data
        """
        print(f"üì• Downloading CVEs from last {days} days...")
        
        # Calculate date range
        end_date = datetime.now()
        start_date = end_date - timedelta(days=days)
        
        # Format dates for API (ISO 8601)
        start_str = start_date.strftime("%Y-%m-%dT00:00:00.000")
        end_str = end_date.strftime("%Y-%m-%dT23:59:59.999")
        
        all_cves = []
        start_index = 0
        results_per_page = 2000  # Max allowed by API
        
        while True:
            # Build API request
            params = {
                "pubStartDate": start_str,
                "pubEndDate": end_str,
                "startIndex": start_index,
                "resultsPerPage": results_per_page
            }
            
            try:
                response = requests.get(self.nvd_url, params=params, timeout=30)
                response.raise_for_status()
                data = response.json()
                
                # Extract vulnerabilities
                vulnerabilities = data.get('vulnerabilities', [])
                all_cves.extend(vulnerabilities)
                
                # Check if there are more results
                total_results = data.get('totalResults', 0)
                if start_index + results_per_page >= total_results:
                    break
                    
                start_index += results_per_page
                
                # Rate limiting - NVD has 5 requests per 30 seconds limit
                import time
                time.sleep(6)  # Wait 6 seconds between requests
                
            except requests.exceptions.RequestException as e:
                print(f"‚ö†Ô∏è  Error fetching CVEs: {e}")
                break
        
        print(f"‚úÖ Downloaded {len(all_cves)} CVEs")
        return {'vulnerabilities': all_cves}
    
    def parse_cves(self, data: Dict) -> List[Dict]:
        """
        Parse CVE data into clean format
        
        Args:
            data: Raw CVE data from NVD
            
        Returns:
            List of parsed CVE dictionaries
        """
        print("üîç Parsing CVE data...")
        cves = []
        
        for vuln_data in data.get('vulnerabilities', []):
            cve = vuln_data.get('cve', {})
            
            # Extract CVE ID
            cve_id = cve.get('id', 'Unknown')
            
            # Extract description
            descriptions = cve.get('descriptions', [])
            description = ''
            for desc in descriptions:
                if desc.get('lang') == 'en':
                    description = desc.get('value', '')
                    break
            
            # Extract CVSS scores
            metrics = cve.get('metrics', {})
            cvss_score = None
            cvss_severity = None
            
            # Try CVSS v3.1 first, then v3.0, then v2
            for version in ['cvssMetricV31', 'cvssMetricV30', 'cvssMetricV2']:
                if version in metrics and metrics[version]:
                    metric = metrics[version][0]
                    cvss_data = metric.get('cvssData', {})
                    cvss_score = cvss_data.get('baseScore')
                    cvss_severity = cvss_data.get('baseSeverity', metric.get('severity'))
                    break
            
            # Extract references
            references = cve.get('references', [])
            ref_urls = [ref.get('url') for ref in references[:3]]  # Limit to 3
            
            # Extract CWE (weakness type)
            weaknesses = cve.get('weaknesses', [])
            cwe_ids = []
            for weakness in weaknesses:
                descriptions = weakness.get('description', [])
                for desc in descriptions:
                    cwe_id = desc.get('value', '')
                    if cwe_id.startswith('CWE-'):
                        cwe_ids.append(cwe_id)
            
            # Publication date
            published = cve.get('published', '')
            if published:
                published = published.split('T')[0]  # Just date, not time
            
            # Create clean CVE object
            parsed_cve = {
                'id': cve_id,
                'description': description,
                'cvss_score': cvss_score,
                'cvss_severity': cvss_severity or 'UNKNOWN',
                'published': published,
                'cwe_ids': cwe_ids,
                'references': ref_urls,
                'type': 'cve'
            }
            
            # Create searchable text
            cwe_text = ', '.join(cwe_ids) if cwe_ids else 'N/A'
            parsed_cve['searchable_text'] = f"""
            CVE: {cve_id}
            Severity: {cvss_severity or 'UNKNOWN'} (Score: {cvss_score or 'N/A'})
            Published: {published}
            Weakness: {cwe_text}
            Description: {description}
            """.strip()
            
            cves.append(parsed_cve)
        
        print(f"‚úÖ Parsed {len(cves)} CVEs")
        return cves


class CISAKEVLoader:
    """Handles downloading and parsing CISA Known Exploited Vulnerabilities"""
    
    def __init__(self):
        self.kev_url = "https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json"
        
    def download_kev_catalog(self) -> Dict:
        """
        Download CISA KEV catalog
        
        Returns:
            Dict of KEV data
        """
        print("üì• Downloading CISA Known Exploited Vulnerabilities...")
        
        try:
            response = requests.get(self.kev_url, timeout=30)
            response.raise_for_status()
            data = response.json()
            
            vuln_count = len(data.get('vulnerabilities', []))
            print(f"‚úÖ Downloaded {vuln_count} known exploited vulnerabilities")
            return data
            
        except requests.exceptions.RequestException as e:
            print(f"‚ùå Error downloading KEV catalog: {e}")
            return {'vulnerabilities': []}
    
    def parse_kevs(self, data: Dict) -> List[Dict]:
        """
        Parse KEV data into clean format
        
        Args:
            data: Raw KEV data from CISA
            
        Returns:
            List of parsed KEV dictionaries
        """
        print("üîç Parsing KEV data...")
        kevs = []
        
        for vuln in data.get('vulnerabilities', []):
            kev = {
                'id': vuln.get('cveID', 'Unknown'),
                'vendor': vuln.get('vendorProject', ''),
                'product': vuln.get('product', ''),
                'vulnerability_name': vuln.get('vulnerabilityName', ''),
                'description': vuln.get('shortDescription', ''),
                'required_action': vuln.get('requiredAction', ''),
                'due_date': vuln.get('dueDate', ''),
                'date_added': vuln.get('dateAdded', ''),
                'notes': vuln.get('notes', ''),
                'type': 'kev'
            }
            
            # Create searchable text
            kev['searchable_text'] = f"""
            CVE: {kev['id']} (ACTIVELY EXPLOITED - CISA KEV)
            Vendor: {kev['vendor']}
            Product: {kev['product']}
            Vulnerability: {kev['vulnerability_name']}
            Description: {kev['description']}
            Required Action: {kev['required_action']}
            Date Added to KEV: {kev['date_added']}
            """.strip()
            
            kevs.append(kev)
        
        print(f"‚úÖ Parsed {len(kevs)} KEVs")
        return kevs


# Example usage
if __name__ == "__main__":
    # Test CVE loader
    cve_loader = CVEDataLoader()
    cve_data = cve_loader.download_recent_cves(days=30)
    cves = cve_loader.parse_cves(cve_data)
    print(f"Sample CVE: {cves[0] if cves else 'None'}")
    
    # Test KEV loader
    kev_loader = CISAKEVLoader()
    kev_data = kev_loader.download_kev_catalog()
    kevs = kev_loader.parse_kevs(kev_data)
    print(f"Sample KEV: {kevs[0] if kevs else 'None'}")
